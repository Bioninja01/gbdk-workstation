#include <stdio.h>
#include <gb/gb.h>
#include <gb/drawing.h>
#include "map1.h"
#include "tileTest.h"

#ifndef DEVNAME
#define DEVNAME "james"
#endif

#ifndef TILESIZE
#define TILESIZE 16
#endif

void setup();
void movePlayer(UINT8 x, UINT8 y);
int checkMap(UINT8 playerX, UINT8 playerY);
void normal_Input(UINT8 *x, UINT8 *y);

#define map3Width 20
#define map3Height 18
#define map3Bank 0

unsigned char jim = 0x00;

unsigned char map3[] =
{
  0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,
  0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,
  0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,
  0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,
  0x00,0x02,0x04,0x05,0x04,0x05,0x04,0x05,0x04,0x05,
  0x04,0x05,0x04,0x05,0x04,0x05,0x04,0x05,0x00,0x02,
  0x01,0x03,0x06,0x07,0x06,0x07,0x06,0x07,0x06,0x07,
  0x06,0x07,0x06,0x07,0x06,0x07,0x06,0x07,0x01,0x03,
  0x00,0x02,0x04,0x05,0x14,0x16,0x14,0x16,0x14,0x16,
  0x14,0x16,0x14,0x16,0x14,0x16,0x04,0x05,0x00,0x02,
  0x01,0x03,0x06,0x07,0x15,0x17,0x15,0x10,0x0B,0x0A,
  0x15,0x17,0x15,0x17,0x15,0x17,0x06,0x07,0x01,0x03,
  0x00,0x02,0x04,0x05,0x14,0x16,0x14,0x11,0x13,0x13,
  0x09,0x16,0x14,0x16,0x14,0x16,0x04,0x05,0x00,0x02,
  0x01,0x03,0x06,0x07,0x15,0x17,0x15,0x0D,0x09,0x09,
  0x15,0x17,0x15,0x17,0x15,0x17,0x06,0x07,0x01,0x03,
  0x00,0x02,0x04,0x05,0x14,0x16,0x14,0x16,0x14,0x16,
  0x14,0x16,0x14,0x16,0x14,0x16,0x04,0x05,0x00,0x02,
  0x01,0x03,0x06,0x07,0x15,0x17,0x15,0x17,0x15,0x17,
  0x15,0x17,0x15,0x17,0x15,0x17,0x06,0x07,0x01,0x03,
  0x00,0x02,0x04,0x05,0x14,0x16,0x14,0x16,0x14,0x16,
  0x14,0x16,0x14,0x16,0x14,0x16,0x04,0x05,0x00,0x02,
  0x01,0x03,0x06,0x07,0x15,0x17,0x15,0x17,0x15,0x17,
  0x15,0x17,0x15,0x17,0x15,0x17,0x06,0x07,0x01,0x03,
  0x00,0x02,0x04,0x05,0x14,0x16,0x14,0x16,0x14,0x16,
  0x14,0x16,0x14,0x16,0x14,0x16,0x04,0x05,0x00,0x02,
  0x01,0x03,0x06,0x07,0x15,0x17,0x15,0x17,0x15,0x17,
  0x15,0x17,0x15,0x17,0x15,0x17,0x06,0x07,0x01,0x03,
  0x00,0x02,0x04,0x05,0x14,0x16,0x14,0x16,0x14,0x16,
  0x14,0x16,0x14,0x16,0x14,0x16,0x04,0x05,0x00,0x02,
  0x01,0x03,0x06,0x07,0x15,0x17,0x15,0x17,0x15,0x17,
  0x15,0x17,0x15,0x17,0x15,0x17,0x06,0x07,0x01,0x03,
  0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x14,0x16,
  0x14,0x16,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,
  0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03,0x15,0x17,
  0x15,0x17,0x01,0x03,0x01,0x03,0x01,0x03,0x01,0x03
};


main() {

	char bob;
	UINT8 col;
	UINT8 playerX, playerY;
	UINT8 *x,*y;
	wait_vbl_done();
	DISPLAY_OFF;


	//Gameboy screen size: 160 x 144
	//Gameboy screen tilesize: 20 x 18
	playerX =0; playerY =0;
	x = &playerX;
	y = &playerY;
	set_bkg_data(0,28,TileLabel);
	set_bkg_tiles(*x, *y, 20,18, map3);
	SHOW_BKG;

	DISPLAY_ON;
	SPRITES_8x16;
	set_sprite_data(0, 8, tileTest);
	*x = 72;
	*y = 80;

	set_sprite_tile(0, 0);
    move_sprite(0, *x,*y);
	set_sprite_tile(1, 2);
	move_sprite(0, *x+8,*y);
    SHOW_SPRITES;

	// HIDE_WIN;
	while(1){
		normal_Input(x,y);
		checkMap(*x,*y);

	}
}

void movePlayer(UINT8 x, UINT8 y){
	move_sprite(0, x, y);
	move_sprite(1, x + 8, y);
}

int checkMap(UINT8 playerX, UINT8 playerY){
	unsigned int x = (unsigned int)playerX >>4;
	unsigned int y = (unsigned int)(playerY >>4) -1;
	x = x +x;
	y= y+y;
	// printf(" TIM %u %u %u %u \n", x, y,x+y*20, (unsigned int)map3[x+y*20]);
	if((unsigned int)map3[x+y*20] == 0){
		return 1;
	}
	return 0;
}

void normal_Input(UINT8 *x, UINT8 *y) {
	switch(joypad()) {	
			case J_RIGHT :
				if(checkMap(*x+TILESIZE,*y)){ return;}
				*x = *x+TILESIZE;
				movePlayer(*x,*y);
				delay(100);
				break;
			case J_LEFT : 
				if(checkMap(*x-TILESIZE,*y)){ return;}
				*x = *x-TILESIZE;
				movePlayer(*x,*y);
				delay(100);
				break;
			case J_UP : 
				if(checkMap(*x,*y-TILESIZE)){ return;}
				*y = *y-TILESIZE;
				movePlayer(*x,*y);
				delay(100);
				break;
			case J_DOWN : 
				if(checkMap(*x,*y+TILESIZE)){ return;}
				*y = *y+TILESIZE;
				movePlayer(*x,*y);
				delay(100);
				break;
			case J_START :
				delay(100);
				break;
			case J_SELECT :
				delay(100);
				break;
			case J_A :
				delay(100);
				break;
			case J_B :
				delay(100);
				break;			
			default :
				break;
	}
}